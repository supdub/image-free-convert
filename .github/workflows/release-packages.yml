name: Release Packages

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  package:
    name: Package (${{ matrix.os_name }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-latest
            os_name: linux-x64
          - runner: macos-latest
            os_name: macos
          - runner: windows-latest
            os_name: windows-x64

    env:
      TARGET_OS: ${{ matrix.os_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm

      - name: Install production dependencies
        run: npm ci --omit=dev

      - name: Build archives
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $tag = if ("${{ github.event_name }}" -eq "release") { "${{ github.event.release.tag_name }}" } else { "manual-${{ github.run_number }}" }
          $base = "imgconvertcrop-$tag-$env:TARGET_OS"

          $stage = Join-Path $env:RUNNER_TEMP ("stage-" + $env:TARGET_OS)
          $dist = Join-Path $env:RUNNER_TEMP "dist"

          New-Item -ItemType Directory -Path $stage -Force | Out-Null
          New-Item -ItemType Directory -Path $dist -Force | Out-Null

          Copy-Item "server.js" -Destination $stage -Force
          Copy-Item "package.json" -Destination $stage -Force
          Copy-Item "package-lock.json" -Destination $stage -Force
          Copy-Item "README.md" -Destination $stage -Force
          Copy-Item "public" -Destination $stage -Recurse -Force
          Copy-Item "node_modules" -Destination $stage -Recurse -Force

          @'
          #!/usr/bin/env bash
          set -euo pipefail
          npm start
          '@ | Set-Content (Join-Path $stage "start.sh") -NoNewline

          @'
          @echo off
          npm start
          '@ | Set-Content (Join-Path $stage "start.cmd") -NoNewline

          $zipPath = Join-Path $dist ($base + ".zip")
          $tgzPath = Join-Path $dist ($base + ".tar.gz")

          Compress-Archive -Path (Join-Path $stage "*") -DestinationPath $zipPath -Force
          tar -czf $tgzPath -C $stage .

          "DIST_DIR=$dist" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Upload packaged artifacts
        uses: actions/upload-artifact@v4
        with:
          name: packages-${{ matrix.os_name }}
          path: |
            ${{ env.DIST_DIR }}/*.zip
            ${{ env.DIST_DIR }}/*.tar.gz
          if-no-files-found: error

  attach-to-release:
    name: Attach Artifacts
    runs-on: ubuntu-latest
    needs: package
    if: github.event_name == 'release'
    steps:
      - name: Download packaged artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Upload artifacts to GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload "${{ github.event.release.tag_name }}" dist/* --clobber
