<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ImgConvertCrop.com | Convert, Crop, Compress Images Free</title>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4240863320156963"
     crossorigin="anonymous"></script>
    <style>
      :root {
        --bg-1: #eef4ff;
        --bg-2: #e6eefc;
        --card: rgba(255, 255, 255, 0.96);
        --ink: #122340;
        --muted: #5e7190;
        --line: #d2deef;
        --brand: #1768ff;
        --brand-2: #0b43b5;
        --ok: #0f7a4e;
        --danger: #c42929;
        --shadow: 0 20px 48px rgba(18, 45, 95, 0.15);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Plus Jakarta Sans", "Avenir Next", "Segoe UI", sans-serif;
        color: var(--ink);
        background:
          radial-gradient(circle at 10% 10%, #ffffff 0%, transparent 46%),
          radial-gradient(circle at 90% 14%, #dce9ff 0%, transparent 36%),
          linear-gradient(180deg, var(--bg-1) 0%, var(--bg-2) 100%);
        min-height: 100vh;
      }

      .page {
        max-width: 1040px;
        margin: 28px auto;
        padding: 0 18px 22px;
      }

      .card {
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: 18px;
        backdrop-filter: blur(12px);
        box-shadow: var(--shadow);
        overflow: hidden;
      }

      .head {
        padding: 22px 22px 14px;
        border-bottom: 1px solid var(--line);
      }

      .brand-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 700;
        color: #1f4f9f;
        border: 1px solid #cfe0f6;
        background: #f4f8ff;
        margin-bottom: 10px;
      }

      h1 {
        margin: 0 0 8px;
        font-size: clamp(1.65rem, 2.1vw, 2rem);
        letter-spacing: -0.02em;
      }

      .subtitle {
        margin: 0;
        color: var(--muted);
        font-size: 0.96rem;
      }

      .quick-flow {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 12px;
      }

      .flow-pill {
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid #d5e2f4;
        background: #f8fbff;
        color: #345987;
        font-size: 12px;
        font-weight: 600;
      }

      .tabs {
        display: flex;
        gap: 8px;
        padding: 12px 14px 10px;
        border-bottom: 1px solid var(--line);
        flex-wrap: nowrap;
        overflow-x: auto;
        background: #f7faff;
      }

      .tab-btn {
        border: 1px solid #cfdbef;
        background: #f2f6ff;
        color: #35547f;
        padding: 9px 16px;
        border-radius: 999px;
        cursor: pointer;
        font-weight: 700;
        font-size: 0.9rem;
        width: auto;
        transition: transform 120ms ease, box-shadow 120ms ease, background-color 120ms ease;
        box-shadow: none;
      }

      .tab-btn.active {
        background: linear-gradient(180deg, #2b7bff 0%, #1768ff 100%);
        border-color: #1768ff;
        color: #ffffff;
        box-shadow: 0 6px 14px rgba(23, 104, 255, 0.28);
      }

      .tab-btn:hover {
        transform: translateY(-1px);
      }

      .panel {
        display: none;
        padding: 18px 18px 22px;
      }

      .panel.active {
        display: block;
      }

      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 14px;
      }

      .full {
        grid-column: 1 / -1;
      }

      label {
        display: block;
        margin-bottom: 7px;
        font-size: 12px;
        font-weight: 700;
        text-transform: none;
        letter-spacing: 0.02em;
        color: #2f4467;
      }

      input,
      select,
      button {
        width: 100%;
        border: 1px solid #cfdced;
        border-radius: 12px;
        padding: 11px 12px;
        font-size: 14px;
        background: #fbfdff;
      }

      button {
        background: linear-gradient(180deg, #2b7bff 0%, #1768ff 100%);
        border-color: #1768ff;
        color: #fff;
        cursor: pointer;
        font-weight: 700;
        letter-spacing: 0.01em;
        box-shadow: 0 8px 16px rgba(23, 104, 255, 0.28);
      }

      button.alt {
        background: #f2f6ff;
        border-color: #ccd9f0;
        color: #1b3d74;
        box-shadow: none;
      }

      input:focus,
      select:focus,
      button:focus-visible {
        outline: none;
        border-color: #7aa9ff;
        box-shadow: 0 0 0 3px rgba(23, 104, 255, 0.16);
      }

      button:disabled {
        opacity: 0.7;
        cursor: not-allowed;
      }

      .status {
        margin-top: 14px;
        font-size: 14px;
        color: #2a4570;
        padding: 10px 12px;
        border-radius: 10px;
        background: #f3f8ff;
        border: 1px solid #d8e4f5;
      }
      .status:empty {
        display: none;
      }

      .status.error {
        color: var(--danger);
        background: #fff1f1;
        border-color: #f2c6c6;
      }

      .status.ok {
        color: var(--ok);
        background: #eefaf4;
        border-color: #bde8cf;
      }

      .crop-shell {
        border: 1px solid var(--line);
        border-radius: 14px;
        background: #f8fbff;
        padding: 12px;
      }

      .crop-canvas-wrap {
        width: 100%;
        overflow: auto;
        border-radius: 10px;
        background: linear-gradient(135deg, #d7e2f5 0%, #e8effd 100%);
        border: 1px solid #cfdbef;
      }

      #cropCanvas {
        display: block;
        max-width: 100%;
        margin: 0 auto;
        cursor: crosshair;
        touch-action: none;
      }

      .note {
        color: var(--muted);
        font-size: 12px;
        margin-bottom: 0;
      }

      .inline-toggle {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 10px;
        border-radius: 10px;
        background: #f3f7ff;
        border: 1px solid #d8e3f4;
      }

      .inline-toggle input {
        width: auto;
      }

      .hidden {
        display: none;
      }

      .ad-wrap {
        margin: 14px 0 6px;
        border: 1px solid #d9e3f2;
        border-radius: 12px;
        background: #f8fbff;
        padding: 8px;
      }

      .ad-wrap.bottom {
        margin-top: 18px;
      }

      .left-rail-ad {
        position: fixed;
        top: 120px;
        left: 14px;
        width: 190px;
        z-index: 20;
      }

      .right-rail-ad {
        position: fixed;
        top: 120px;
        right: 14px;
        width: 190px;
        z-index: 20;
      }

      .left-rail-ad .ad-wrap {
        margin: 0;
        padding: 10px;
        border-radius: 14px;
        box-shadow: 0 10px 20px rgba(16, 36, 74, 0.12);
      }

      .right-rail-ad .ad-wrap {
        margin: 0;
        padding: 10px;
        border-radius: 14px;
        box-shadow: 0 10px 20px rgba(16, 36, 74, 0.12);
      }

      .tool-card {
        margin-top: 12px;
        padding: 14px;
        border: 1px solid #d8e3f3;
        border-radius: 14px;
        background: linear-gradient(180deg, #fbfdff 0%, #f5f9ff 100%);
      }

      .tool-title {
        margin: 0 0 4px;
        font-size: 15px;
        font-weight: 700;
        color: #223f67;
      }

      .tool-subtitle {
        margin: 0 0 10px;
        color: var(--muted);
        font-size: 12px;
      }

      @media (max-width: 760px) {
        .page {
          margin-top: 20px;
          padding: 0 12px 16px;
        }

        .head {
          padding: 18px 16px 12px;
        }

        .tabs {
          padding: 12px 12px 10px;
        }

        .panel {
          padding: 16px 14px 18px;
        }

        .grid {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 1300px) {
        .left-rail-ad {
          display: none;
        }
        .right-rail-ad {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <aside class="left-rail-ad" aria-label="Advertisement">
      <div class="ad-wrap">
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-4240863320156963"
             data-ad-slot="3548309138"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
      </div>
    </aside>
    <aside class="right-rail-ad" aria-label="Advertisement">
      <div class="ad-wrap">
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-4240863320156963"
             data-ad-slot="2551746648"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
      </div>
    </aside>
    <main class="page">
      <section class="card">
        <div class="head">
          <div class="brand-chip">imgconvertcrop.com</div>
          <h1>ImgConvertCrop</h1>
          <p class="subtitle">Fast, free image tools in one place: convert formats, crop precisely, and compress in seconds. We never save your images.</p>
          <div class="quick-flow">
            <span class="flow-pill">1. Upload</span>
            <span class="flow-pill">2. Adjust</span>
            <span class="flow-pill">3. Download</span>
            <span class="flow-pill">We never save your images</span>
          </div>
        </div>

        <div class="tabs" role="tablist">
          <button type="button" class="tab-btn active" data-tab="convert" role="tab">Convert</button>
          <button type="button" class="tab-btn" data-tab="crop" role="tab">Crop</button>
          <button type="button" class="tab-btn" data-tab="compress" role="tab">Compress</button>
        </div>

        <section class="panel active" id="panel-convert">
          <div class="tool-card">
            <p class="tool-title">Convert Images</p>
            <p class="tool-subtitle">Change image format while keeping quality under your control.</p>
          <div class="ad-wrap">
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-4240863320156963"
                 data-ad-slot="1000000001"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
          </div>
          <div class="grid">
            <div class="full">
              <label for="convertImage">Image File</label>
              <input id="convertImage" type="file" accept="image/*" />
            </div>
            <div>
              <label for="convertFormat">Output Format</label>
              <select id="convertFormat">
                <option value="jpeg">JPEG</option>
                <option value="png">PNG</option>
                <option value="webp">WEBP</option>
                <option value="avif">AVIF</option>
              </select>
            </div>
            <div>
              <label for="convertQuality">Quality (1-100)</label>
              <input id="convertQuality" type="number" min="1" max="100" value="90" />
            </div>
            <div class="full">
              <button type="button" id="convertBtn">Convert and Download</button>
            </div>
          </div>
          <div class="status" id="convertStatus" aria-live="polite"></div>
          <div class="ad-wrap bottom">
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-4240863320156963"
                 data-ad-slot="3548309138"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
          </div>
          </div>
        </section>

        <section class="panel" id="panel-crop">
          <div class="tool-card">
            <p class="tool-title">Crop Images</p>
            <p class="tool-subtitle">Use the crop frame to focus only on the area you want, then optionally resize.</p>
          <div class="ad-wrap">
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-4240863320156963"
                 data-ad-slot="1000000002"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
          </div>
          <div class="grid">
            <div class="full">
              <label for="cropImage">Image File</label>
              <input id="cropImage" type="file" accept="image/*" />
            </div>
            <div class="full crop-shell">
              <div class="crop-canvas-wrap">
                <canvas id="cropCanvas" width="860" height="480"></canvas>
              </div>
              <p class="note">Drag inside the box to move. Drag corners to resize. Use Confirm Crop when ready.</p>
            </div>

            <div>
              <label for="cropFormat">Output Format</label>
              <select id="cropFormat">
                <option value="png">PNG</option>
                <option value="jpeg">JPEG</option>
                <option value="webp">WEBP</option>
                <option value="avif">AVIF</option>
              </select>
            </div>
            <div>
              <label for="cropQuality">Quality (1-100)</label>
              <input id="cropQuality" type="number" min="1" max="100" value="90" />
            </div>

            <div class="full inline-toggle">
              <input id="enableCropResize" type="checkbox" />
              <label for="enableCropResize" style="margin: 0">Resize after crop</label>
            </div>
            <div class="full note" id="cropResizeExplain">
              If enabled, the cropped image is scaled down to fit within the width/height you provide. It keeps aspect ratio and will not stretch.
            </div>

            <div id="cropResizeWidthWrap" class="hidden">
              <label for="cropResizeWidth">Resize Width</label>
              <input id="cropResizeWidth" type="number" min="1" placeholder="e.g. 800" />
            </div>
            <div id="cropResizeHeightWrap" class="hidden">
              <label for="cropResizeHeight">Resize Height</label>
              <input id="cropResizeHeight" type="number" min="1" placeholder="e.g. 600" />
            </div>

            <div>
              <button type="button" class="alt" id="resetCropBtn">Reset Box</button>
            </div>
            <div>
              <button type="button" id="confirmCropBtn">Confirm Crop and Download</button>
            </div>
          </div>
            <div class="status" id="cropStatus" aria-live="polite"></div>
            <div class="ad-wrap bottom">
              <ins class="adsbygoogle"
                   style="display:block"
                   data-ad-client="ca-pub-4240863320156963"
                   data-ad-slot="3548309138"
                   data-ad-format="auto"
                   data-full-width-responsive="true"></ins>
            </div>
          </div>
        </section>

        <section class="panel" id="panel-compress">
          <div class="tool-card">
            <p class="tool-title">Compress Images</p>
            <p class="tool-subtitle">Reduce file size while preserving the same pixel dimensions.</p>
          <div class="ad-wrap">
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-4240863320156963"
                 data-ad-slot="1000000003"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
          </div>
          <div class="grid">
            <div class="full">
              <label for="compressImage">Image File</label>
              <input id="compressImage" type="file" accept="image/*" />
            </div>
            <div>
              <label for="compressFormat">Output Format</label>
              <select id="compressFormat">
                <option value="jpeg">JPEG</option>
                <option value="webp">WEBP</option>
                <option value="avif">AVIF</option>
                <option value="png">PNG</option>
              </select>
            </div>
            <div>
              <label for="compressQuality">Compression Quality (1-100)</label>
              <input id="compressQuality" type="number" min="1" max="100" value="70" />
            </div>
            <div class="full">
              <p class="note">Compress keeps the same pixel dimensions. It only reduces encoded quality/size.</p>
            </div>
            <div class="full">
              <button type="button" id="compressBtn">Compress and Download</button>
            </div>
          </div>
          <div class="status" id="compressStatus" aria-live="polite"></div>
          <div class="ad-wrap bottom">
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-4240863320156963"
                 data-ad-slot="3548309138"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
          </div>
          </div>
        </section>
      </section>
    </main>

    <script>
      document.querySelectorAll('.adsbygoogle').forEach(() => {
        try { (adsbygoogle = window.adsbygoogle || []).push({}); } catch (_e) {}
      });

      const tabButtons = Array.from(document.querySelectorAll('.tab-btn'));
      const panels = {
        convert: document.getElementById('panel-convert'),
        crop: document.getElementById('panel-crop'),
        compress: document.getElementById('panel-compress')
      };

      function setStatus(el, message, type) {
        el.textContent = message;
        el.className = `status${type ? ` ${type}` : ''}`;
      }

      function toQuality(value, fallback) {
        const n = Number(value);
        if (!Number.isFinite(n)) return fallback;
        return Math.max(0.01, Math.min(1, n / 100));
      }

      function extForFormat(format) {
        return format === 'jpeg' ? 'jpg' : format;
      }

      function isIOSLike() {
        const ua = navigator.userAgent || '';
        return /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      }

      async function downloadBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        if (isIOSLike()) {
          const opened = window.open(url, '_blank');
          if (!opened) {
            window.location.href = url;
          }
          setTimeout(() => URL.revokeObjectURL(url), 60000);
          return 'ios-preview';
        }

        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        link.remove();
        URL.revokeObjectURL(url);
        return 'downloaded';
      }

      function canEncode(mimeType) {
        const c = document.createElement('canvas');
        const out = c.toDataURL(mimeType);
        return out.startsWith(`data:${mimeType}`);
      }

      async function fileToImage(file) {
        const url = URL.createObjectURL(file);
        try {
          const img = new Image();
          await new Promise((resolve, reject) => {
            img.onload = resolve;
            img.onerror = reject;
            img.src = url;
          });
          return img;
        } finally {
          URL.revokeObjectURL(url);
        }
      }

      async function renderToBlob(img, mimeType, quality, sx, sy, sw, sh, dw, dh) {
        const canvas = document.createElement('canvas');
        canvas.width = dw;
        canvas.height = dh;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, sx, sy, sw, sh, 0, 0, dw, dh);
        return new Promise((resolve) => canvas.toBlob(resolve, mimeType, quality));
      }

      tabButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
          const tab = btn.dataset.tab;
          tabButtons.forEach((b) => b.classList.toggle('active', b === btn));
          Object.entries(panels).forEach(([name, panel]) => {
            panel.classList.toggle('active', name === tab);
          });
        });
      });

      // Convert tab
      document.getElementById('convertBtn').addEventListener('click', async () => {
        const fileInput = document.getElementById('convertImage');
        const statusEl = document.getElementById('convertStatus');
        if (!fileInput.files || fileInput.files.length === 0) {
          setStatus(statusEl, 'Choose an image first.', 'error');
          return;
        }

        const file = fileInput.files[0];
        const format = document.getElementById('convertFormat').value;
        const mimeType = `image/${format}`;

        if (!canEncode(mimeType)) {
          setStatus(statusEl, `${format.toUpperCase()} export is not supported in this browser.`, 'error');
          return;
        }

        setStatus(statusEl, 'Converting...');
        try {
          const quality = toQuality(document.getElementById('convertQuality').value, 0.9);
          const img = await fileToImage(file);
          const blob = await renderToBlob(img, mimeType, quality, 0, 0, img.width, img.height, img.width, img.height);
          if (!blob) throw new Error('Failed to convert image.');
          const base = file.name.replace(/\.[^.]+$/, '') || 'image';
          const mode = await downloadBlob(blob, `${base}-converted.${extForFormat(format)}`);
          setStatus(
            statusEl,
            mode === 'ios-preview' ? 'Preview opened. On iPhone tap Share, then Save Image.' : 'Done. Download started.',
            'ok'
          );
        } catch (err) {
          setStatus(statusEl, err.message || 'Convert failed.', 'error');
        }
      });

      // Crop tab
      const cropCanvas = document.getElementById('cropCanvas');
      const cropCtx = cropCanvas.getContext('2d');
      const cropStatus = document.getElementById('cropStatus');
      const cropImageInput = document.getElementById('cropImage');

      const cropState = {
        img: null,
        scale: 1,
        offsetX: 0,
        offsetY: 0,
        box: { x: 80, y: 60, w: 240, h: 180 },
        mode: null,
        handle: null,
        startX: 0,
        startY: 0,
        startBox: null
      };

      function drawCropCanvas() {
        cropCtx.clearRect(0, 0, cropCanvas.width, cropCanvas.height);
        cropCtx.fillStyle = '#dfe9f8';
        cropCtx.fillRect(0, 0, cropCanvas.width, cropCanvas.height);

        if (!cropState.img) {
          cropCtx.fillStyle = '#4f678a';
          cropCtx.font = '16px Segoe UI';
          cropCtx.fillText('Upload an image to crop', 24, 34);
          return;
        }

        const img = cropState.img;
        const scale = Math.min(cropCanvas.width / img.width, cropCanvas.height / img.height);
        const drawW = img.width * scale;
        const drawH = img.height * scale;
        const ox = (cropCanvas.width - drawW) / 2;
        const oy = (cropCanvas.height - drawH) / 2;

        cropState.scale = scale;
        cropState.offsetX = ox;
        cropState.offsetY = oy;

        cropCtx.drawImage(img, ox, oy, drawW, drawH);

        const b = cropState.box;
        const x = ox + b.x * scale;
        const y = oy + b.y * scale;
        const w = b.w * scale;
        const h = b.h * scale;

        // Shade only the outside area; keep the crop area as the original image.
        cropCtx.fillStyle = 'rgba(80,88,102,0.24)';
        cropCtx.fillRect(ox, oy, drawW, Math.max(0, y - oy)); // top
        cropCtx.fillRect(ox, y + h, drawW, Math.max(0, (oy + drawH) - (y + h))); // bottom
        cropCtx.fillRect(ox, y, Math.max(0, x - ox), h); // left
        cropCtx.fillRect(x + w, y, Math.max(0, (ox + drawW) - (x + w)), h); // right

        cropCtx.strokeStyle = '#0f62fe';
        cropCtx.lineWidth = 2;
        cropCtx.strokeRect(x, y, w, h);

        const hs = 6;
        const handles = [
          [x, y],
          [x + w, y],
          [x, y + h],
          [x + w, y + h]
        ];
        cropCtx.fillStyle = '#ffffff';
        cropCtx.strokeStyle = '#0f62fe';
        handles.forEach(([hx, hy]) => {
          cropCtx.beginPath();
          cropCtx.rect(hx - hs, hy - hs, hs * 2, hs * 2);
          cropCtx.fill();
          cropCtx.stroke();
        });
      }

      function clampBoxToImage() {
        if (!cropState.img) return;
        const img = cropState.img;
        const b = cropState.box;
        b.w = Math.max(20, Math.min(b.w, img.width));
        b.h = Math.max(20, Math.min(b.h, img.height));
        b.x = Math.max(0, Math.min(b.x, img.width - b.w));
        b.y = Math.max(0, Math.min(b.y, img.height - b.h));
      }

      function getPointer(e) {
        const rect = cropCanvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return {
          x: clientX - rect.left,
          y: clientY - rect.top
        };
      }

      function hitTestHandle(px, py) {
        const b = cropState.box;
        const s = cropState.scale;
        const ox = cropState.offsetX;
        const oy = cropState.offsetY;
        const x = ox + b.x * s;
        const y = oy + b.y * s;
        const w = b.w * s;
        const h = b.h * s;
        const tol = 10;

        const points = {
          nw: { x, y },
          ne: { x: x + w, y },
          sw: { x, y: y + h },
          se: { x: x + w, y: y + h }
        };

        for (const [name, p] of Object.entries(points)) {
          if (Math.abs(px - p.x) <= tol && Math.abs(py - p.y) <= tol) return name;
        }

        if (px >= x && px <= x + w && py >= y && py <= y + h) return 'move';
        return null;
      }

      function onCropDown(e) {
        if (!cropState.img) return;
        e.preventDefault();
        const p = getPointer(e);
        const hit = hitTestHandle(p.x, p.y);
        if (!hit) return;
        cropState.mode = hit === 'move' ? 'move' : 'resize';
        cropState.handle = hit;
        cropState.startX = p.x;
        cropState.startY = p.y;
        cropState.startBox = { ...cropState.box };
      }

      function onCropMove(e) {
        if (!cropState.img || !cropState.mode) return;
        e.preventDefault();
        const p = getPointer(e);
        const dx = (p.x - cropState.startX) / cropState.scale;
        const dy = (p.y - cropState.startY) / cropState.scale;
        const b = cropState.box;
        const s = cropState.startBox;

        if (cropState.mode === 'move') {
          b.x = s.x + dx;
          b.y = s.y + dy;
        } else {
          const min = 20;
          if (cropState.handle.includes('n')) {
            b.y = s.y + dy;
            b.h = s.h - dy;
          }
          if (cropState.handle.includes('s')) {
            b.h = s.h + dy;
          }
          if (cropState.handle.includes('w')) {
            b.x = s.x + dx;
            b.w = s.w - dx;
          }
          if (cropState.handle.includes('e')) {
            b.w = s.w + dx;
          }

          if (b.w < min) {
            b.w = min;
            if (cropState.handle.includes('w')) b.x = s.x + (s.w - min);
          }
          if (b.h < min) {
            b.h = min;
            if (cropState.handle.includes('n')) b.y = s.y + (s.h - min);
          }
        }

        clampBoxToImage();
        drawCropCanvas();
      }

      function onCropUp() {
        cropState.mode = null;
        cropState.handle = null;
      }

      cropCanvas.addEventListener('mousedown', onCropDown);
      window.addEventListener('mousemove', onCropMove);
      window.addEventListener('mouseup', onCropUp);

      cropCanvas.addEventListener('touchstart', onCropDown, { passive: false });
      window.addEventListener('touchmove', onCropMove, { passive: false });
      window.addEventListener('touchend', onCropUp, { passive: false });

      cropImageInput.addEventListener('change', async () => {
        if (!cropImageInput.files || cropImageInput.files.length === 0) return;
        try {
          const img = await fileToImage(cropImageInput.files[0]);
          cropState.img = img;
          cropState.box = {
            x: img.width * 0.1,
            y: img.height * 0.1,
            w: img.width * 0.8,
            h: img.height * 0.8
          };
          clampBoxToImage();
          drawCropCanvas();
          setStatus(cropStatus, 'Image loaded. Adjust crop and confirm.', 'ok');
        } catch {
          setStatus(cropStatus, 'Failed to load image.', 'error');
        }
      });

      document.getElementById('resetCropBtn').addEventListener('click', () => {
        if (!cropState.img) return;
        const img = cropState.img;
        cropState.box = {
          x: img.width * 0.1,
          y: img.height * 0.1,
          w: img.width * 0.8,
          h: img.height * 0.8
        };
        drawCropCanvas();
        setStatus(cropStatus, 'Crop box reset.', 'ok');
      });

      const enableCropResize = document.getElementById('enableCropResize');
      const cropResizeWidthWrap = document.getElementById('cropResizeWidthWrap');
      const cropResizeHeightWrap = document.getElementById('cropResizeHeightWrap');
      enableCropResize.addEventListener('change', () => {
        const show = enableCropResize.checked;
        cropResizeWidthWrap.classList.toggle('hidden', !show);
        cropResizeHeightWrap.classList.toggle('hidden', !show);
      });

      document.getElementById('confirmCropBtn').addEventListener('click', async () => {
        if (!cropState.img || !cropImageInput.files || cropImageInput.files.length === 0) {
          setStatus(cropStatus, 'Upload an image first.', 'error');
          return;
        }

        const format = document.getElementById('cropFormat').value;
        const mimeType = `image/${format}`;
        if (!canEncode(mimeType)) {
          setStatus(cropStatus, `${format.toUpperCase()} export is not supported in this browser.`, 'error');
          return;
        }

        try {
          setStatus(cropStatus, 'Processing crop...');
          const img = cropState.img;
          const b = cropState.box;
          let outW = Math.max(1, Math.round(b.w));
          let outH = Math.max(1, Math.round(b.h));

          if (enableCropResize.checked) {
            const rw = Number(document.getElementById('cropResizeWidth').value);
            const rh = Number(document.getElementById('cropResizeHeight').value);
            const hasW = Number.isFinite(rw) && rw > 0;
            const hasH = Number.isFinite(rh) && rh > 0;
            if (!hasW && !hasH) {
              throw new Error('Provide resize width and/or height.');
            }
            const ratio = Math.min(hasW ? rw / outW : Infinity, hasH ? rh / outH : Infinity, 1);
            outW = Math.max(1, Math.round(outW * ratio));
            outH = Math.max(1, Math.round(outH * ratio));
          }

          const quality = toQuality(document.getElementById('cropQuality').value, 0.9);
          const blob = await renderToBlob(
            img,
            mimeType,
            quality,
            Math.round(b.x),
            Math.round(b.y),
            Math.round(b.w),
            Math.round(b.h),
            outW,
            outH
          );

          if (!blob) throw new Error('Crop failed.');
          const file = cropImageInput.files[0];
          const base = file.name.replace(/\.[^.]+$/, '') || 'image';
          const mode = await downloadBlob(blob, `${base}-crop.${extForFormat(format)}`);
          setStatus(
            cropStatus,
            mode === 'ios-preview' ? 'Preview opened. On iPhone tap Share, then Save Image.' : 'Crop confirmed. Download started.',
            'ok'
          );
        } catch (err) {
          setStatus(cropStatus, err.message || 'Crop failed.', 'error');
        }
      });

      drawCropCanvas();

      // Compress tab
      document.getElementById('compressBtn').addEventListener('click', async () => {
        const fileInput = document.getElementById('compressImage');
        const statusEl = document.getElementById('compressStatus');
        if (!fileInput.files || fileInput.files.length === 0) {
          setStatus(statusEl, 'Choose an image first.', 'error');
          return;
        }

        const file = fileInput.files[0];
        const format = document.getElementById('compressFormat').value;
        const mimeType = `image/${format}`;
        if (!canEncode(mimeType)) {
          setStatus(statusEl, `${format.toUpperCase()} export is not supported in this browser.`, 'error');
          return;
        }

        setStatus(statusEl, 'Compressing (same dimensions)...');
        try {
          const img = await fileToImage(file);
          const quality = toQuality(document.getElementById('compressQuality').value, 0.7);
          const blob = await renderToBlob(img, mimeType, quality, 0, 0, img.width, img.height, img.width, img.height);
          if (!blob) throw new Error('Compress failed.');
          const base = file.name.replace(/\.[^.]+$/, '') || 'image';
          const mode = await downloadBlob(blob, `${base}-compressed.${extForFormat(format)}`);
          setStatus(
            statusEl,
            mode === 'ios-preview' ? 'Preview opened. On iPhone tap Share, then Save Image.' : 'Compression done. Download started.',
            'ok'
          );
        } catch (err) {
          setStatus(statusEl, err.message || 'Compress failed.', 'error');
        }
      });
    </script>
  </body>
</html>
