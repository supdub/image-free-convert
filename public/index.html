<!doctype html>
<html lang="__HTML_LANG__" dir="__HTML_DIR__">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="__META_DESCRIPTION__" />
    <meta name="robots" content="index,follow,max-image-preview:large,max-snippet:-1,max-video-preview:-1" />
    <link rel="canonical" href="__CANONICAL_URL__" />
    __ALT_HREFLANG_LINKS__
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="ImgConvertCrop" />
    <meta property="og:url" content="__CANONICAL_URL__" />
    <meta property="og:title" content="__OG_TITLE__" />
    <meta property="og:description" content="__OG_DESCRIPTION__" />
    <meta property="og:image" content="https://imgconvertcrop.com/og-image.png" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="__TWITTER_TITLE__" />
    <meta name="twitter:description" content="__TWITTER_DESCRIPTION__" />
    <meta name="twitter:image" content="https://imgconvertcrop.com/og-image.png" />
    <title>__PAGE_TITLE__</title>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4240863320156963"
     crossorigin="anonymous"></script>
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "WebSite",
        "name": "ImgConvertCrop",
        "url": "__CANONICAL_URL__",
        "description": "__META_DESCRIPTION__"
      }
    </script>
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "SoftwareApplication",
        "name": "ImgConvertCrop",
        "applicationCategory": "MultimediaApplication",
        "operatingSystem": "Any",
        "url": "__CANONICAL_URL__",
        "offers": {
          "@type": "Offer",
          "price": "0",
          "priceCurrency": "USD"
        },
        "description": "__META_DESCRIPTION__"
      }
    </script>
    <style>
      :root {
        --bg-1: #eef4ff;
        --bg-2: #e6eefc;
        --card: rgba(255, 255, 255, 0.96);
        --ink: #122340;
        --muted: #5e7190;
        --line: #d2deef;
        --brand: #1768ff;
        --brand-2: #0b43b5;
        --ok: #0f7a4e;
        --danger: #c42929;
        --shadow: 0 20px 48px rgba(18, 45, 95, 0.15);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Plus Jakarta Sans", "Avenir Next", "Segoe UI", sans-serif;
        color: var(--ink);
        background:
          radial-gradient(circle at 10% 10%, #ffffff 0%, transparent 46%),
          radial-gradient(circle at 90% 14%, #dce9ff 0%, transparent 36%),
          linear-gradient(180deg, var(--bg-1) 0%, var(--bg-2) 100%);
        min-height: 100vh;
      }

      .page {
        max-width: 1040px;
        margin: 28px auto;
        padding: 0 18px 22px;
      }

      .card {
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: 18px;
        backdrop-filter: blur(12px);
        box-shadow: var(--shadow);
        overflow: hidden;
      }

      .head {
        padding: 22px 22px 14px;
        border-bottom: 1px solid var(--line);
      }

      .head-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }

      .brand-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 700;
        color: #1f4f9f;
        border: 1px solid #cfe0f6;
        background: #f4f8ff;
        margin-bottom: 10px;
      }

      .locale-picker {
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 180px;
      }

      .locale-picker label {
        margin: 0;
        font-size: 12px;
      }

      .locale-picker select {
        min-width: 120px;
        padding: 8px 10px;
      }

      h1 {
        margin: 0 0 8px;
        font-size: clamp(1.65rem, 2.1vw, 2rem);
        letter-spacing: -0.02em;
      }

      .subtitle {
        margin: 0;
        color: var(--muted);
        font-size: 0.96rem;
      }

      .quick-flow {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 12px;
      }

      .oss-callout {
        margin-top: 12px;
        padding: 10px 12px;
        border: 1px solid #d5e2f4;
        border-radius: 12px;
        background: #f8fbff;
        color: #2a4f82;
        font-size: 13px;
      }

      .oss-callout a {
        color: #1256c8;
        font-weight: 700;
        text-decoration: none;
      }

      .oss-callout a:hover {
        text-decoration: underline;
      }

      .flow-pill {
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid #d5e2f4;
        background: #f8fbff;
        color: #345987;
        font-size: 12px;
        font-weight: 600;
      }

      .tabs {
        display: flex;
        gap: 8px;
        padding: 12px 14px 10px;
        border-bottom: 1px solid var(--line);
        flex-wrap: nowrap;
        overflow-x: auto;
        background: #f7faff;
      }

      .tab-btn {
        border: 1px solid #cfdbef;
        background: #f2f6ff;
        color: #35547f;
        padding: 9px 16px;
        border-radius: 999px;
        cursor: pointer;
        font-weight: 700;
        font-size: 0.9rem;
        width: auto;
        transition: transform 120ms ease, box-shadow 120ms ease, background-color 120ms ease;
        box-shadow: none;
      }

      .tab-btn.active {
        background: linear-gradient(180deg, #2b7bff 0%, #1768ff 100%);
        border-color: #1768ff;
        color: #ffffff;
        box-shadow: 0 6px 14px rgba(23, 104, 255, 0.28);
      }

      .tab-btn:hover {
        transform: translateY(-1px);
      }

      .panel {
        display: none;
        padding: 18px 18px 22px;
      }

      .panel.active {
        display: block;
      }

      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 14px;
      }

      .full {
        grid-column: 1 / -1;
      }

      label {
        display: block;
        margin-bottom: 7px;
        font-size: 12px;
        font-weight: 700;
        text-transform: none;
        letter-spacing: 0.02em;
        color: #2f4467;
      }

      input,
      select,
      button {
        width: 100%;
        border: 1px solid #cfdced;
        border-radius: 12px;
        padding: 11px 12px;
        font-size: 14px;
        background: #fbfdff;
      }

      button {
        background: linear-gradient(180deg, #2b7bff 0%, #1768ff 100%);
        border-color: #1768ff;
        color: #fff;
        cursor: pointer;
        font-weight: 700;
        letter-spacing: 0.01em;
        box-shadow: 0 8px 16px rgba(23, 104, 255, 0.28);
      }

      button.alt {
        background: #f2f6ff;
        border-color: #ccd9f0;
        color: #1b3d74;
        box-shadow: none;
      }

      input:focus,
      select:focus,
      button:focus-visible {
        outline: none;
        border-color: #7aa9ff;
        box-shadow: 0 0 0 3px rgba(23, 104, 255, 0.16);
      }

      button:disabled {
        opacity: 0.7;
        cursor: not-allowed;
      }

      .status {
        margin-top: 14px;
        font-size: 14px;
        color: #2a4570;
        padding: 10px 12px;
        border-radius: 10px;
        background: #f3f8ff;
        border: 1px solid #d8e4f5;
      }
      .status:empty {
        display: none;
      }

      .status.error {
        color: var(--danger);
        background: #fff1f1;
        border-color: #f2c6c6;
      }

      .status.ok {
        color: var(--ok);
        background: #eefaf4;
        border-color: #bde8cf;
      }

      .crop-shell {
        border: 1px solid var(--line);
        border-radius: 14px;
        background: #f8fbff;
        padding: 12px;
      }

      .crop-canvas-wrap {
        width: 100%;
        overflow: auto;
        -webkit-overflow-scrolling: touch;
        border-radius: 10px;
        background: linear-gradient(135deg, #d7e2f5 0%, #e8effd 100%);
        border: 1px solid #cfdbef;
      }

      #cropCanvas {
        display: block;
        max-width: 100%;
        margin: 0 auto;
        cursor: crosshair;
        touch-action: none;
      }

      .note {
        color: var(--muted);
        font-size: 12px;
        margin-bottom: 0;
      }

      .inline-toggle {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 10px;
        border-radius: 10px;
        background: #f3f7ff;
        border: 1px solid #d8e3f4;
      }

      .inline-toggle input {
        width: auto;
      }

      .hidden {
        display: none;
      }

      .ad-wrap {
        margin: 14px 0 6px;
        border: 1px solid #d9e3f2;
        border-radius: 12px;
        background: #f8fbff;
        padding: 8px;
      }

      .ad-wrap.bottom {
        margin-top: 18px;
      }

      .left-rail-ad {
        position: fixed;
        top: 120px;
        left: 14px;
        width: 190px;
        z-index: 20;
      }

      .right-rail-ad {
        position: fixed;
        top: 120px;
        right: 14px;
        width: 190px;
        z-index: 20;
      }

      .left-rail-ad .ad-wrap {
        margin: 0;
        padding: 10px;
        border-radius: 14px;
        box-shadow: 0 10px 20px rgba(16, 36, 74, 0.12);
      }

      .right-rail-ad .ad-wrap {
        margin: 0;
        padding: 10px;
        border-radius: 14px;
        box-shadow: 0 10px 20px rgba(16, 36, 74, 0.12);
      }

      .tool-card {
        margin-top: 12px;
        padding: 14px;
        border: 1px solid #d8e3f3;
        border-radius: 14px;
        background: linear-gradient(180deg, #fbfdff 0%, #f5f9ff 100%);
      }

      .tool-title {
        margin: 0 0 4px;
        font-size: 15px;
        font-weight: 700;
        color: #223f67;
      }

      .tool-subtitle {
        margin: 0 0 10px;
        color: var(--muted);
        font-size: 12px;
      }

      .seo-copy {
        margin-top: 16px;
        padding: 14px;
        border: 1px solid #d8e3f3;
        border-radius: 14px;
        background: #f9fcff;
      }

      .seo-copy h2 {
        margin: 0 0 8px;
        font-size: 18px;
        color: #1d3f70;
      }

      .seo-copy p {
        margin: 0 0 8px;
        color: #34557f;
        line-height: 1.5;
        font-size: 14px;
      }

      .seo-copy ul {
        margin: 0;
        padding-left: 18px;
        color: #34557f;
        font-size: 14px;
      }

      .keyword-copy {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px dashed #d5e2f4;
      }

      .keyword-copy h3 {
        margin: 0 0 8px;
        font-size: 15px;
        color: #244a7f;
      }

      .keyword-copy p {
        margin: 0;
        color: #3d5f8c;
      }

      .related-links {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px dashed #d5e2f4;
      }

      .related-links h3 {
        margin: 0 0 8px;
        font-size: 15px;
        color: #244a7f;
      }

      .related-links ul {
        margin: 0;
        padding-left: 18px;
      }

      .related-links a {
        color: #1c59b8;
        text-decoration: none;
      }

      .related-links a:hover {
        text-decoration: underline;
      }

      @media (max-width: 760px) {
        .page {
          margin-top: 20px;
          padding: 0 12px 16px;
        }

        .head {
          padding: 18px 16px 12px;
        }

        .tabs {
          padding: 12px 12px 10px;
        }

        .panel {
          padding: 16px 14px 18px;
        }

        .grid {
          grid-template-columns: 1fr;
        }

        .tabs {
          gap: 10px;
        }

        .tab-btn {
          padding: 10px 16px;
        }

        .crop-shell {
          padding: 10px;
        }

        .inline-toggle {
          padding: 10px 12px;
        }

        #cropCanvas {
          touch-action: none;
        }
      }

      @media (max-width: 1300px) {
        .left-rail-ad {
          display: none;
        }
        .right-rail-ad {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <aside class="left-rail-ad" aria-label="Advertisement">
      <div class="ad-wrap">
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-4240863320156963"
             data-ad-slot="3548309138"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
      </div>
    </aside>
    <aside class="right-rail-ad" aria-label="Advertisement">
      <div class="ad-wrap">
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-4240863320156963"
             data-ad-slot="2551746648"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
      </div>
    </aside>
    <main class="page">
      <section class="card">
        <div class="head">
          <div class="head-top">
            <div class="brand-chip">imgconvertcrop.com</div>
            <div class="locale-picker">
              <label for="languageSelect" data-i18n="lang.label">Language</label>
              <select id="languageSelect">__LANG_OPTIONS_HTML__</select>
            </div>
          </div>
          <h1>__HERO_TITLE__</h1>
          <p class="subtitle">__HERO_SUBTITLE__</p>
          <p class="oss-callout">
            <span data-i18n="oss.prefix">Open source:</span>
            <a href="https://github.com/supdub/image-free-convert" target="_blank" rel="noopener noreferrer" data-i18n="oss.link">GitHub repo</a>
            <span data-i18n="oss.suffix">Deploy your own version.</span>
          </p>
          <div class="quick-flow">
            <span class="flow-pill" data-i18n="flow.upload">1. Upload</span>
            <span class="flow-pill" data-i18n="flow.adjust">2. Adjust</span>
            <span class="flow-pill" data-i18n="flow.download">3. Download</span>
            <span class="flow-pill" data-i18n="flow.privacy">We never save your images</span>
          </div>
        </div>

        <div class="tabs" role="tablist">
          <button type="button" class="tab-btn __CONVERT_TAB_ACTIVE__" data-tab="convert" role="tab" data-i18n="tab.convert">Convert</button>
          <button type="button" class="tab-btn __CROP_TAB_ACTIVE__" data-tab="crop" role="tab" data-i18n="tab.crop">Crop</button>
          <button type="button" class="tab-btn __COMPRESS_TAB_ACTIVE__" data-tab="compress" role="tab" data-i18n="tab.compress">Compress</button>
        </div>

        <section class="panel __CONVERT_PANEL_ACTIVE__" id="panel-convert">
          <div class="tool-card">
            <p class="tool-title" data-i18n="convert.title">Convert Images</p>
            <p class="tool-subtitle" data-i18n="convert.subtitle">Change image format while keeping quality under your control.</p>
          <div class="ad-wrap">
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-4240863320156963"
                 data-ad-slot="3548309138"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
          </div>
          <div class="grid">
            <div class="full">
              <label for="convertImage" data-i18n="field.imageFile">Image File</label>
              <input id="convertImage" type="file" accept="image/*" />
            </div>
            <div>
              <label for="convertFormat" data-i18n="field.outputFormat">Output Format</label>
              <select id="convertFormat">
                <option value="jpeg">JPEG</option>
                <option value="png">PNG</option>
                <option value="webp">WEBP</option>
                <option value="avif">AVIF</option>
              </select>
            </div>
            <div>
              <label for="convertQuality" data-i18n="field.quality">Quality (1-100)</label>
              <input id="convertQuality" type="number" min="1" max="100" value="90" />
            </div>
            <div class="full">
              <button type="button" id="convertBtn" data-i18n="btn.convertDownload">Convert and Download</button>
            </div>
          </div>
          <div class="status" id="convertStatus" aria-live="polite"></div>
          <div class="ad-wrap bottom">
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-4240863320156963"
                 data-ad-slot="3548309138"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
          </div>
          <section class="seo-copy" aria-label="What this tool does">
            <h2>__SEO_H2__</h2>
            <p>__SEO_P1__</p>
            <p>__SEO_P2__</p>
            <ul>
              <li>__SEO_LI_1__</li>
              <li>__SEO_LI_2__</li>
              <li>__SEO_LI_3__</li>
            </ul>
            <div class="keyword-copy" aria-label="Keyword search intent">
              <h3>__KEYWORD_TITLE__</h3>
              <p>__KEYWORD_TEXT__</p>
            </div>
            <nav class="related-links" aria-label="Related tool pages">
              <h3 data-i18n="seo.relatedPages">Related pages</h3>
              <ul>
                __RELATED_LINKS_HTML__
              </ul>
            </nav>
          </section>
          </div>
        </section>

        <section class="panel __CROP_PANEL_ACTIVE__" id="panel-crop">
          <div class="tool-card">
            <p class="tool-title" data-i18n="crop.title">Crop Images</p>
            <p class="tool-subtitle" data-i18n="crop.subtitle">Use the crop frame to focus only on the area you want, then optionally resize.</p>
          <div class="ad-wrap">
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-4240863320156963"
                 data-ad-slot="3548309138"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
          </div>
          <div class="grid">
            <div class="full">
              <label for="cropImage" data-i18n="field.imageFile">Image File</label>
              <input id="cropImage" type="file" accept="image/*" />
            </div>
            <div class="full crop-shell">
              <div class="crop-canvas-wrap">
                <canvas id="cropCanvas" width="860" height="480"></canvas>
              </div>
              <p class="note" data-i18n="crop.instructions">Drag inside the box to move. Drag corners to resize. Use Confirm Crop when ready.</p>
            </div>

            <div>
              <label for="cropFormat" data-i18n="field.outputFormat">Output Format</label>
              <select id="cropFormat">
                <option value="png">PNG</option>
                <option value="jpeg">JPEG</option>
                <option value="webp">WEBP</option>
                <option value="avif">AVIF</option>
              </select>
            </div>
            <div>
              <label for="cropQuality" data-i18n="field.quality">Quality (1-100)</label>
              <input id="cropQuality" type="number" min="1" max="100" value="90" />
            </div>
            <div>
              <label for="cropAspectRatio" data-i18n="crop.aspectRatio">Aspect Ratio</label>
              <select id="cropAspectRatio">
                <option value="free" data-i18n="crop.ratio.free">Free</option>
                <option value="1:1">1:1</option>
                <option value="4:3">4:3</option>
                <option value="3:4">3:4</option>
                <option value="16:9">16:9</option>
                <option value="9:16">9:16</option>
                <option value="3:2">3:2</option>
                <option value="2:3">2:3</option>
              </select>
            </div>

            <div class="full inline-toggle">
              <input id="enableCropResize" type="checkbox" />
              <label for="enableCropResize" style="margin: 0" data-i18n="crop.resizeAfter">Resize after crop</label>
            </div>
            <div class="full note" id="cropResizeExplain" data-i18n="crop.resizeExplain">
              If enabled, the cropped image is scaled down to fit within the width/height you provide. It keeps aspect ratio and will not stretch.
            </div>

            <div id="cropResizeWidthWrap" class="hidden">
              <label for="cropResizeWidth" data-i18n="crop.resizeWidth">Resize Width</label>
              <input id="cropResizeWidth" type="number" min="1" placeholder="e.g. 800" />
            </div>
            <div id="cropResizeHeightWrap" class="hidden">
              <label for="cropResizeHeight" data-i18n="crop.resizeHeight">Resize Height</label>
              <input id="cropResizeHeight" type="number" min="1" placeholder="e.g. 600" />
            </div>

            <div>
              <button type="button" class="alt" id="resetCropBtn" data-i18n="btn.resetBox">Reset Box</button>
            </div>
            <div>
              <button type="button" id="confirmCropBtn" data-i18n="btn.confirmCropDownload">Confirm Crop and Download</button>
            </div>
          </div>
            <div class="status" id="cropStatus" aria-live="polite"></div>
            <div class="ad-wrap bottom">
              <ins class="adsbygoogle"
                   style="display:block"
                   data-ad-client="ca-pub-4240863320156963"
                   data-ad-slot="3548309138"
                   data-ad-format="auto"
                   data-full-width-responsive="true"></ins>
            </div>
          </div>
        </section>

        <section class="panel __COMPRESS_PANEL_ACTIVE__" id="panel-compress">
          <div class="tool-card">
            <p class="tool-title" data-i18n="compress.title">Compress Images</p>
            <p class="tool-subtitle" data-i18n="compress.subtitle">Reduce file size while preserving the same pixel dimensions.</p>
          <div class="ad-wrap">
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-4240863320156963"
                 data-ad-slot="3548309138"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
          </div>
          <div class="grid">
            <div class="full">
              <label for="compressImage" data-i18n="field.imageFile">Image File</label>
              <input id="compressImage" type="file" accept="image/*" />
            </div>
            <div>
              <label for="compressFormat" data-i18n="field.outputFormat">Output Format</label>
              <select id="compressFormat">
                <option value="jpeg">JPEG</option>
                <option value="webp">WEBP</option>
                <option value="avif">AVIF</option>
                <option value="png">PNG</option>
              </select>
            </div>
            <div>
              <label for="compressQuality" data-i18n="compress.quality">Compression Quality (1-100)</label>
              <input id="compressQuality" type="number" min="1" max="100" value="70" />
            </div>
            <div class="full">
              <p class="note" data-i18n="compress.note">Compress keeps the same pixel dimensions. It only reduces encoded quality/size.</p>
            </div>
            <div class="full">
              <button type="button" id="compressBtn" data-i18n="btn.compressDownload">Compress and Download</button>
            </div>
          </div>
          <div class="status" id="compressStatus" aria-live="polite"></div>
          <div class="ad-wrap bottom">
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-4240863320156963"
                 data-ad-slot="3548309138"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
          </div>
          </div>
        </section>
      </section>
    </main>

    <script>
      window.__PAGE_CONFIG__ = __PAGE_CONFIG_JSON__;

      document.querySelectorAll('.adsbygoogle').forEach(() => {
        try { (adsbygoogle = window.adsbygoogle || []).push({}); } catch (_e) {}
      });

      const pageConfig = window.__PAGE_CONFIG__ || {};
      const locale = pageConfig.locale || 'en';
      const i18n = {
        en: {
          'lang.label': 'Language',
          'flow.upload': '1. Upload',
          'flow.adjust': '2. Adjust',
          'flow.download': '3. Download',
          'flow.privacy': 'We never save your images',
          'tab.convert': 'Convert',
          'tab.crop': 'Crop',
          'tab.compress': 'Compress',
          'oss.prefix': 'Open source:',
          'oss.link': 'GitHub repo',
          'oss.suffix': 'Deploy your own version.',
          'convert.title': 'Convert Images',
          'convert.subtitle': 'Change image format while keeping quality under your control.',
          'crop.title': 'Crop Images',
          'crop.subtitle': 'Use the crop frame to focus only on the area you want, then optionally resize.',
          'compress.title': 'Compress Images',
          'compress.subtitle': 'Reduce file size while preserving the same pixel dimensions.',
          'field.imageFile': 'Image File',
          'field.outputFormat': 'Output Format',
          'field.quality': 'Quality (1-100)',
          'compress.quality': 'Compression Quality (1-100)',
          'btn.convertDownload': 'Convert and Download',
          'btn.resetBox': 'Reset Box',
          'btn.confirmCropDownload': 'Confirm Crop and Download',
          'btn.compressDownload': 'Compress and Download',
          'crop.instructions': 'Drag inside the box to move. Drag corners to resize. Use Confirm Crop when ready.',
          'crop.aspectRatio': 'Aspect Ratio',
          'crop.ratio.free': 'Free',
          'crop.resizeAfter': 'Resize after crop',
          'crop.resizeExplain':
            'If enabled, the cropped image is scaled down to fit within the width/height you provide. It keeps aspect ratio and will not stretch.',
          'crop.resizeWidth': 'Resize Width',
          'crop.resizeHeight': 'Resize Height',
          'compress.note': 'Compress keeps the same pixel dimensions. It only reduces encoded quality/size.',
          'seo.relatedPages': 'Related pages',
          'status.chooseImage': 'Choose an image first.',
          'status.uploadFirst': 'Upload an image first.',
          'status.converting': 'Converting...',
          'status.compressing': 'Compressing (same dimensions)...',
          'status.cropProcessing': 'Processing crop...',
          'status.doneDownload': 'Done. Download started.',
          'status.cropDone': 'Crop confirmed. Download started.',
          'status.compressDone': 'Compression done. Download started.',
          'status.previewIos': 'Preview opened. On iPhone tap Share, then Save Image.',
          'status.imageLoaded': 'Image loaded. Adjust crop and confirm.',
          'status.loadFailed': 'Failed to load image.',
          'status.cropReset': 'Crop box reset.',
          'status.cropCanvasPrompt': 'Upload an image to crop',
          'error.notSupported': '{format} export is not supported in this browser.',
          'error.resizeParams': 'Provide resize width and/or height.',
          'error.convertFailed': 'Convert failed.',
          'error.cropFailed': 'Crop failed.',
          'error.compressFailed': 'Compress failed.',
          'ph.resizeWidth': 'e.g. 800',
          'ph.resizeHeight': 'e.g. 600'
        },
        es: {
          'lang.label': 'Idioma',
          'flow.upload': '1. Subir',
          'flow.adjust': '2. Ajustar',
          'flow.download': '3. Descargar',
          'flow.privacy': 'Nunca guardamos tus imagenes',
          'tab.convert': 'Convertir',
          'tab.crop': 'Recortar',
          'tab.compress': 'Comprimir',
          'oss.prefix': 'Codigo abierto:',
          'oss.link': 'Repositorio en GitHub',
          'oss.suffix': 'Despliega tu propia version.',
          'convert.title': 'Convertir imagenes',
          'convert.subtitle': 'Cambia el formato de imagen con control de calidad.',
          'crop.title': 'Recortar imagenes',
          'crop.subtitle': 'Usa el marco de recorte y, si quieres, cambia el tamano.',
          'compress.title': 'Comprimir imagenes',
          'compress.subtitle': 'Reduce el tamano del archivo manteniendo las dimensiones.',
          'field.imageFile': 'Archivo de imagen',
          'field.outputFormat': 'Formato de salida',
          'field.quality': 'Calidad (1-100)',
          'compress.quality': 'Calidad de compresion (1-100)',
          'btn.convertDownload': 'Convertir y descargar',
          'btn.resetBox': 'Restablecer caja',
          'btn.confirmCropDownload': 'Confirmar recorte y descargar',
          'btn.compressDownload': 'Comprimir y descargar',
          'crop.instructions': 'Arrastra dentro para mover. Arrastra esquinas para cambiar tamano.',
          'crop.aspectRatio': 'Relacion de aspecto',
          'crop.ratio.free': 'Libre',
          'crop.resizeAfter': 'Redimensionar despues de recortar',
          'crop.resizeExplain': 'Si lo activas, la imagen recortada se ajusta al ancho/alto indicado sin deformar.',
          'crop.resizeWidth': 'Ancho',
          'crop.resizeHeight': 'Alto',
          'compress.note': 'Comprimir mantiene las mismas dimensiones de pixeles.',
          'seo.relatedPages': 'Paginas relacionadas',
          'status.chooseImage': 'Elige una imagen primero.',
          'status.uploadFirst': 'Sube una imagen primero.',
          'status.converting': 'Convirtiendo...',
          'status.compressing': 'Comprimiendo (mismas dimensiones)...',
          'status.cropProcessing': 'Procesando recorte...',
          'status.doneDownload': 'Listo. Descarga iniciada.',
          'status.cropDone': 'Recorte confirmado. Descarga iniciada.',
          'status.compressDone': 'Compresion lista. Descarga iniciada.',
          'status.previewIos': 'Vista previa abierta. En iPhone, toca Share y luego Save Image.',
          'status.imageLoaded': 'Imagen cargada. Ajusta y confirma el recorte.',
          'status.loadFailed': 'No se pudo cargar la imagen.',
          'status.cropReset': 'Caja de recorte reiniciada.',
          'status.cropCanvasPrompt': 'Sube una imagen para recortar',
          'error.notSupported': 'La exportacion {format} no es compatible con este navegador.',
          'error.resizeParams': 'Indica ancho y/o alto para redimensionar.',
          'error.convertFailed': 'Fallo al convertir.',
          'error.cropFailed': 'Fallo al recortar.',
          'error.compressFailed': 'Fallo al comprimir.',
          'ph.resizeWidth': 'p. ej. 800',
          'ph.resizeHeight': 'p. ej. 600'
        },
        zh: {
          'lang.label': '语言',
          'flow.upload': '1. 上传',
          'flow.adjust': '2. 调整',
          'flow.download': '3. 下载',
          'flow.privacy': '我们不会保存你的图片',
          'tab.convert': '转换',
          'tab.crop': '裁剪',
          'tab.compress': '压缩',
          'oss.prefix': '开源项目：',
          'oss.link': 'GitHub 仓库',
          'oss.suffix': '可部署你自己的版本。',
          'convert.title': '转换图片',
          'convert.subtitle': '在保证质量可控的情况下转换图片格式。',
          'crop.title': '裁剪图片',
          'crop.subtitle': '使用裁剪框选择区域，并可在裁剪后调整尺寸。',
          'compress.title': '压缩图片',
          'compress.subtitle': '在保持像素尺寸不变的前提下减小文件体积。',
          'field.imageFile': '图片文件',
          'field.outputFormat': '输出格式',
          'field.quality': '质量 (1-100)',
          'compress.quality': '压缩质量 (1-100)',
          'btn.convertDownload': '转换并下载',
          'btn.resetBox': '重置裁剪框',
          'btn.confirmCropDownload': '确认裁剪并下载',
          'btn.compressDownload': '压缩并下载',
          'crop.instructions': '在框内拖动可移动，拖动角点可调整大小。',
          'crop.aspectRatio': '宽高比',
          'crop.ratio.free': '自由',
          'crop.resizeAfter': '裁剪后调整尺寸',
          'crop.resizeExplain': '启用后，裁剪结果会按你填写的宽高等比缩小，不会拉伸。',
          'crop.resizeWidth': '宽度',
          'crop.resizeHeight': '高度',
          'compress.note': '压缩仅降低编码体积，不改变像素尺寸。',
          'seo.relatedPages': '相关页面',
          'status.chooseImage': '请先选择图片。',
          'status.uploadFirst': '请先上传图片。',
          'status.converting': '正在转换...',
          'status.compressing': '正在压缩（保持尺寸）...',
          'status.cropProcessing': '正在处理裁剪...',
          'status.doneDownload': '完成，开始下载。',
          'status.cropDone': '裁剪完成，开始下载。',
          'status.compressDone': '压缩完成，开始下载。',
          'status.previewIos': '已打开预览。iPhone 上请点 Share 再点 Save Image。',
          'status.imageLoaded': '图片已加载，请调整后确认裁剪。',
          'status.loadFailed': '图片加载失败。',
          'status.cropReset': '裁剪框已重置。',
          'status.cropCanvasPrompt': '上传一张图片开始裁剪',
          'error.notSupported': '当前浏览器不支持导出 {format}。',
          'error.resizeParams': '请填写缩放宽度和/或高度。',
          'error.convertFailed': '转换失败。',
          'error.cropFailed': '裁剪失败。',
          'error.compressFailed': '压缩失败。',
          'ph.resizeWidth': '例如 800',
          'ph.resizeHeight': '例如 600'
        },
        hi: {
          'lang.label': 'भाषा',
          'flow.upload': '1. अपलोड',
          'flow.adjust': '2. एडजस्ट',
          'flow.download': '3. डाउनलोड',
          'flow.privacy': 'हम आपकी इमेज सेव नहीं करते',
          'tab.convert': 'कन्वर्ट',
          'tab.crop': 'क्रॉप',
          'tab.compress': 'कंप्रेस',
          'oss.prefix': 'ओपन सोर्स:',
          'oss.link': 'GitHub रिपॉजिटरी',
          'oss.suffix': 'अपना वर्जन खुद डिप्लॉय करें।',
          'convert.title': 'इमेज कन्वर्ट करें',
          'convert.subtitle': 'क्वालिटी नियंत्रण के साथ फॉर्मेट बदलें।',
          'crop.title': 'इमेज क्रॉप करें',
          'crop.subtitle': 'क्रॉप बॉक्स से हिस्सा चुनें, फिर जरूरत हो तो रिसाइज़ करें।',
          'compress.title': 'इमेज कंप्रेस करें',
          'compress.subtitle': 'पिक्सेल साइज़ वही रखते हुए फाइल साइज़ कम करें।',
          'field.imageFile': 'इमेज फाइल',
          'field.outputFormat': 'आउटपुट फॉर्मेट',
          'field.quality': 'क्वालिटी (1-100)',
          'compress.quality': 'कंप्रेशन क्वालिटी (1-100)',
          'btn.convertDownload': 'कन्वर्ट और डाउनलोड',
          'btn.resetBox': 'बॉक्स रीसेट करें',
          'btn.confirmCropDownload': 'क्रॉप कन्फर्म और डाउनलोड',
          'btn.compressDownload': 'कंप्रेस और डाउनलोड',
          'crop.instructions': 'बॉक्स के अंदर ड्रैग करके मूव करें। कोनों से साइज़ बदलें।',
          'crop.aspectRatio': 'आस्पेक्ट रेशियो',
          'crop.ratio.free': 'फ्री',
          'crop.resizeAfter': 'क्रॉप के बाद रिसाइज़',
          'crop.resizeExplain': 'चालू करने पर, क्रॉप की गई इमेज दी गई चौड़ाई/ऊंचाई में बिना खिंचे फिट होगी।',
          'crop.resizeWidth': 'चौड़ाई',
          'crop.resizeHeight': 'ऊंचाई',
          'compress.note': 'कंप्रेस करने पर पिक्सेल डायमेंशन वही रहते हैं।',
          'seo.relatedPages': 'संबंधित पेज',
          'status.chooseImage': 'पहले एक इमेज चुनें।',
          'status.uploadFirst': 'पहले एक इमेज अपलोड करें।',
          'status.converting': 'कन्वर्ट हो रहा है...',
          'status.compressing': 'कंप्रेस हो रहा है (वही डायमेंशन)...',
          'status.cropProcessing': 'क्रॉप प्रोसेस हो रहा है...',
          'status.doneDownload': 'हो गया। डाउनलोड शुरू हुआ।',
          'status.cropDone': 'क्रॉप पूरा। डाउनलोड शुरू हुआ।',
          'status.compressDone': 'कंप्रेशन पूरा। डाउनलोड शुरू हुआ।',
          'status.previewIos': 'प्रिव्यू खुल गया। iPhone पर Share दबाएं, फिर Save Image करें।',
          'status.imageLoaded': 'इमेज लोड हो गई। क्रॉप एडजस्ट करके कन्फर्म करें।',
          'status.loadFailed': 'इमेज लोड नहीं हुई।',
          'status.cropReset': 'क्रॉप बॉक्स रीसेट हो गया।',
          'status.cropCanvasPrompt': 'क्रॉप करने के लिए इमेज अपलोड करें',
          'error.notSupported': 'इस ब्राउज़र में {format} एक्सपोर्ट सपोर्ट नहीं है।',
          'error.resizeParams': 'रिसाइज़ के लिए चौड़ाई और/या ऊंचाई दें।',
          'error.convertFailed': 'कन्वर्ट विफल।',
          'error.cropFailed': 'क्रॉप विफल।',
          'error.compressFailed': 'कंप्रेस विफल।',
          'ph.resizeWidth': 'जैसे 800',
          'ph.resizeHeight': 'जैसे 600'
        },
        ar: {
          'lang.label': 'اللغة',
          'flow.upload': '1. رفع',
          'flow.adjust': '2. تعديل',
          'flow.download': '3. تنزيل',
          'flow.privacy': 'نحن لا نحفظ صورك',
          'tab.convert': 'تحويل',
          'tab.crop': 'قص',
          'tab.compress': 'ضغط',
          'oss.prefix': 'مفتوح المصدر:',
          'oss.link': 'مستودع GitHub',
          'oss.suffix': 'انشر نسختك الخاصة.',
          'convert.title': 'تحويل الصور',
          'convert.subtitle': 'غيّر صيغة الصورة مع التحكم في الجودة.',
          'crop.title': 'قص الصور',
          'crop.subtitle': 'استخدم إطار القص لتحديد الجزء المطلوب ثم غيّر الحجم اختياريًا.',
          'compress.title': 'ضغط الصور',
          'compress.subtitle': 'قلّل حجم الملف مع الحفاظ على نفس الأبعاد.',
          'field.imageFile': 'ملف الصورة',
          'field.outputFormat': 'صيغة الإخراج',
          'field.quality': 'الجودة (1-100)',
          'compress.quality': 'جودة الضغط (1-100)',
          'btn.convertDownload': 'تحويل وتنزيل',
          'btn.resetBox': 'إعادة ضبط الإطار',
          'btn.confirmCropDownload': 'تأكيد القص والتنزيل',
          'btn.compressDownload': 'ضغط وتنزيل',
          'crop.instructions': 'اسحب داخل الإطار للتحريك واسحب الزوايا لتغيير الحجم.',
          'crop.aspectRatio': 'نسبة الأبعاد',
          'crop.ratio.free': 'حر',
          'crop.resizeAfter': 'تغيير الحجم بعد القص',
          'crop.resizeExplain': 'عند التفعيل، يتم تصغير الصورة المقصوصة لتناسب العرض/الارتفاع بدون تمدد.',
          'crop.resizeWidth': 'العرض',
          'crop.resizeHeight': 'الارتفاع',
          'compress.note': 'الضغط يحافظ على نفس أبعاد البكسل.',
          'seo.relatedPages': 'صفحات ذات صلة',
          'status.chooseImage': 'اختر صورة أولاً.',
          'status.uploadFirst': 'ارفع صورة أولاً.',
          'status.converting': 'جارٍ التحويل...',
          'status.compressing': 'جارٍ الضغط (نفس الأبعاد)...',
          'status.cropProcessing': 'جارٍ معالجة القص...',
          'status.doneDownload': 'تم. بدأ التنزيل.',
          'status.cropDone': 'تم القص. بدأ التنزيل.',
          'status.compressDone': 'تم الضغط. بدأ التنزيل.',
          'status.previewIos': 'تم فتح المعاينة. في iPhone اضغط Share ثم Save Image.',
          'status.imageLoaded': 'تم تحميل الصورة. عدّل القص ثم أكّد.',
          'status.loadFailed': 'فشل تحميل الصورة.',
          'status.cropReset': 'تمت إعادة ضبط إطار القص.',
          'status.cropCanvasPrompt': 'ارفع صورة للقص',
          'error.notSupported': 'تصدير {format} غير مدعوم في هذا المتصفح.',
          'error.resizeParams': 'أدخل عرضًا و/أو ارتفاعًا لتغيير الحجم.',
          'error.convertFailed': 'فشل التحويل.',
          'error.cropFailed': 'فشل القص.',
          'error.compressFailed': 'فشل الضغط.',
          'ph.resizeWidth': 'مثال 800',
          'ph.resizeHeight': 'مثال 600'
        }
      };

      function t(key, vars) {
        const dict = i18n[locale] || i18n.en;
        let text = dict[key] || i18n.en[key] || key;
        if (vars) {
          Object.entries(vars).forEach(([name, value]) => {
            text = text.replace(`{${name}}`, value);
          });
        }
        return text;
      }

      function applyTranslations() {
        document.querySelectorAll('[data-i18n]').forEach((el) => {
          const key = el.getAttribute('data-i18n');
          el.textContent = t(key);
        });
        document.getElementById('cropResizeWidth').placeholder = t('ph.resizeWidth');
        document.getElementById('cropResizeHeight').placeholder = t('ph.resizeHeight');
      }

      function localePathFor(basePath, targetLocale) {
        const cleanBase = !basePath || basePath === '/' ? '' : basePath;
        return `/${targetLocale}${cleanBase}`;
      }

      applyTranslations();

      const languageSelect = document.getElementById('languageSelect');
      languageSelect.addEventListener('change', () => {
        const targetLocale = languageSelect.value;
        const basePath = pageConfig.basePath || '/';
        document.cookie = `lang=${targetLocale}; Path=/; Max-Age=31536000; SameSite=Lax`;
        window.location.href = localePathFor(basePath, targetLocale);
      });

      const tabButtons = Array.from(document.querySelectorAll('.tab-btn'));
      const isCoarsePointer = window.matchMedia && window.matchMedia('(pointer: coarse)').matches;
      const panels = {
        convert: document.getElementById('panel-convert'),
        crop: document.getElementById('panel-crop'),
        compress: document.getElementById('panel-compress')
      };
      const tabToPath = {
        convert: localePathFor('/convert', locale),
        crop: localePathFor('/crop', locale),
        compress: localePathFor('/compress', locale)
      };

      function setStatus(el, message, type) {
        el.textContent = message;
        el.className = `status${type ? ` ${type}` : ''}`;
      }

      function toQuality(value, fallback) {
        const n = Number(value);
        if (!Number.isFinite(n)) return fallback;
        return Math.max(0.01, Math.min(1, n / 100));
      }

      function extForFormat(format) {
        return format === 'jpeg' ? 'jpg' : format;
      }

      function isIOSLike() {
        const ua = navigator.userAgent || '';
        return /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      }

      async function downloadBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        if (isIOSLike()) {
          const opened = window.open(url, '_blank');
          if (!opened) {
            window.location.href = url;
          }
          setTimeout(() => URL.revokeObjectURL(url), 60000);
          return 'ios-preview';
        }

        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        link.remove();
        URL.revokeObjectURL(url);
        return 'downloaded';
      }

      function canEncode(mimeType) {
        const c = document.createElement('canvas');
        const out = c.toDataURL(mimeType);
        return out.startsWith(`data:${mimeType}`);
      }

      async function fileToImage(file) {
        const url = URL.createObjectURL(file);
        try {
          const img = new Image();
          await new Promise((resolve, reject) => {
            img.onload = resolve;
            img.onerror = reject;
            img.src = url;
          });
          return img;
        } finally {
          URL.revokeObjectURL(url);
        }
      }

      async function renderToBlob(img, mimeType, quality, sx, sy, sw, sh, dw, dh) {
        const canvas = document.createElement('canvas');
        canvas.width = dw;
        canvas.height = dh;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, sx, sy, sw, sh, 0, 0, dw, dh);
        return new Promise((resolve) => canvas.toBlob(resolve, mimeType, quality));
      }

      function setActiveTab(tab, shouldUpdateUrl = false) {
        tabButtons.forEach((b) => b.classList.toggle('active', b.dataset.tab === tab));
        Object.entries(panels).forEach(([name, panel]) => {
          panel.classList.toggle('active', name === tab);
        });

        if (shouldUpdateUrl && tabToPath[tab]) {
          history.replaceState(null, '', tabToPath[tab]);
        }
      }

      tabButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
          setActiveTab(btn.dataset.tab, true);
        });
      });

      setActiveTab(pageConfig.activeTab || 'convert', false);

      if (pageConfig.convertFormat) {
        document.getElementById('convertFormat').value = pageConfig.convertFormat;
      }
      if (typeof pageConfig.convertQuality === 'number') {
        document.getElementById('convertQuality').value = String(pageConfig.convertQuality);
      }
      if (pageConfig.compressFormat) {
        document.getElementById('compressFormat').value = pageConfig.compressFormat;
      }
      if (typeof pageConfig.compressQuality === 'number') {
        document.getElementById('compressQuality').value = String(pageConfig.compressQuality);
      }

      // Convert tab
      document.getElementById('convertBtn').addEventListener('click', async () => {
        const fileInput = document.getElementById('convertImage');
        const statusEl = document.getElementById('convertStatus');
        if (!fileInput.files || fileInput.files.length === 0) {
          setStatus(statusEl, t('status.chooseImage'), 'error');
          return;
        }

        const file = fileInput.files[0];
        const format = document.getElementById('convertFormat').value;
        const mimeType = `image/${format}`;

        if (!canEncode(mimeType)) {
          setStatus(statusEl, t('error.notSupported', { format: format.toUpperCase() }), 'error');
          return;
        }

        setStatus(statusEl, t('status.converting'));
        try {
          const quality = toQuality(document.getElementById('convertQuality').value, 0.9);
          const img = await fileToImage(file);
          const blob = await renderToBlob(img, mimeType, quality, 0, 0, img.width, img.height, img.width, img.height);
          if (!blob) throw new Error('Failed to convert image.');
          const base = file.name.replace(/\.[^.]+$/, '') || 'image';
          const mode = await downloadBlob(blob, `${base}-converted.${extForFormat(format)}`);
          setStatus(
            statusEl,
            mode === 'ios-preview' ? t('status.previewIos') : t('status.doneDownload'),
            'ok'
          );
        } catch (err) {
          setStatus(statusEl, err.message || t('error.convertFailed'), 'error');
        }
      });

      // Crop tab
      const cropCanvas = document.getElementById('cropCanvas');
      const cropCtx = cropCanvas.getContext('2d');
      const cropStatus = document.getElementById('cropStatus');
      const cropImageInput = document.getElementById('cropImage');

      const cropState = {
        img: null,
        aspectRatio: null,
        scale: 1,
        offsetX: 0,
        offsetY: 0,
        box: { x: 80, y: 60, w: 240, h: 180 },
        mode: null,
        handle: null,
        startX: 0,
        startY: 0,
        startBox: null
      };

      function parseAspectRatio(raw) {
        if (!raw || raw === 'free') return null;
        const parts = String(raw).split(':');
        if (parts.length !== 2) return null;
        const w = Number(parts[0]);
        const h = Number(parts[1]);
        if (!Number.isFinite(w) || !Number.isFinite(h) || w <= 0 || h <= 0) return null;
        return w / h;
      }

      function buildDefaultBox(img) {
        return {
          x: img.width * 0.1,
          y: img.height * 0.1,
          w: img.width * 0.8,
          h: img.height * 0.8
        };
      }

      function buildRatioBox(img, ratio) {
        const maxW = img.width * 0.9;
        const maxH = img.height * 0.9;
        let w = maxW;
        let h = w / ratio;
        if (h > maxH) {
          h = maxH;
          w = h * ratio;
        }
        return {
          x: (img.width - w) / 2,
          y: (img.height - h) / 2,
          w,
          h
        };
      }

      function applyCropPreset(preset) {
        if (!preset) return;
        const cropAspectRatio = document.getElementById('cropAspectRatio');
        if (!cropAspectRatio) return;
        if (preset === 'square') {
          cropAspectRatio.value = '1:1';
        } else if (preset === '16:9') {
          cropAspectRatio.value = '16:9';
        }
      }

      function setCropAspectRatio(value, fitToRatio = false) {
        cropState.aspectRatio = parseAspectRatio(value);
        if (!cropState.img) return;
        if (fitToRatio && cropState.aspectRatio) {
          cropState.box = buildRatioBox(cropState.img, cropState.aspectRatio);
          clampBoxToImage();
          drawCropCanvas();
        } else if (fitToRatio && !cropState.aspectRatio) {
          cropState.box = buildDefaultBox(cropState.img);
          clampBoxToImage();
          drawCropCanvas();
        }
      }

      function drawCropCanvas() {
        cropCtx.clearRect(0, 0, cropCanvas.width, cropCanvas.height);
        cropCtx.fillStyle = '#dfe9f8';
        cropCtx.fillRect(0, 0, cropCanvas.width, cropCanvas.height);

        if (!cropState.img) {
          cropCtx.fillStyle = '#4f678a';
          cropCtx.font = '16px Segoe UI';
          cropCtx.fillText(t('status.cropCanvasPrompt'), 24, 34);
          return;
        }

        const img = cropState.img;
        const scale = Math.min(cropCanvas.width / img.width, cropCanvas.height / img.height);
        const drawW = img.width * scale;
        const drawH = img.height * scale;
        const ox = (cropCanvas.width - drawW) / 2;
        const oy = (cropCanvas.height - drawH) / 2;

        cropState.scale = scale;
        cropState.offsetX = ox;
        cropState.offsetY = oy;

        cropCtx.drawImage(img, ox, oy, drawW, drawH);

        const b = cropState.box;
        const x = ox + b.x * scale;
        const y = oy + b.y * scale;
        const w = b.w * scale;
        const h = b.h * scale;

        // Shade only the outside area; keep the crop area as the original image.
        cropCtx.fillStyle = 'rgba(80,88,102,0.24)';
        cropCtx.fillRect(ox, oy, drawW, Math.max(0, y - oy)); // top
        cropCtx.fillRect(ox, y + h, drawW, Math.max(0, (oy + drawH) - (y + h))); // bottom
        cropCtx.fillRect(ox, y, Math.max(0, x - ox), h); // left
        cropCtx.fillRect(x + w, y, Math.max(0, (ox + drawW) - (x + w)), h); // right

        cropCtx.strokeStyle = '#0f62fe';
        cropCtx.lineWidth = 2;
        cropCtx.strokeRect(x, y, w, h);

        const hs = isCoarsePointer ? 10 : 6;
        const handles = [
          [x, y],
          [x + w, y],
          [x, y + h],
          [x + w, y + h]
        ];
        cropCtx.fillStyle = '#ffffff';
        cropCtx.strokeStyle = '#0f62fe';
        handles.forEach(([hx, hy]) => {
          cropCtx.beginPath();
          cropCtx.rect(hx - hs, hy - hs, hs * 2, hs * 2);
          cropCtx.fill();
          cropCtx.stroke();
        });
      }

      function clampBoxToImage() {
        if (!cropState.img) return;
        const img = cropState.img;
        const b = cropState.box;
        const ratio = cropState.aspectRatio;
        if (ratio) {
          let w = Math.max(20, b.w);
          let h = w / ratio;
          if (h < 20) {
            h = 20;
            w = h * ratio;
          }
          if (w > img.width) {
            w = img.width;
            h = w / ratio;
          }
          if (h > img.height) {
            h = img.height;
            w = h * ratio;
          }
          b.w = w;
          b.h = h;
        } else {
          b.w = Math.max(20, Math.min(b.w, img.width));
          b.h = Math.max(20, Math.min(b.h, img.height));
        }
        b.x = Math.max(0, Math.min(b.x, img.width - b.w));
        b.y = Math.max(0, Math.min(b.y, img.height - b.h));
      }

      function getPointer(e) {
        const rect = cropCanvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return {
          x: clientX - rect.left,
          y: clientY - rect.top
        };
      }

      function hitTestHandle(px, py) {
        const b = cropState.box;
        const s = cropState.scale;
        const ox = cropState.offsetX;
        const oy = cropState.offsetY;
        const x = ox + b.x * s;
        const y = oy + b.y * s;
        const w = b.w * s;
        const h = b.h * s;
        const tol = isCoarsePointer ? 18 : 10;

        const points = {
          nw: { x, y },
          ne: { x: x + w, y },
          sw: { x, y: y + h },
          se: { x: x + w, y: y + h }
        };

        for (const [name, p] of Object.entries(points)) {
          if (Math.abs(px - p.x) <= tol && Math.abs(py - p.y) <= tol) return name;
        }

        if (px >= x && px <= x + w && py >= y && py <= y + h) return 'move';
        return null;
      }

      function onCropDown(e) {
        if (!cropState.img) return;
        e.preventDefault();
        const p = getPointer(e);
        const hit = hitTestHandle(p.x, p.y);
        if (!hit) return;
        cropState.mode = hit === 'move' ? 'move' : 'resize';
        cropState.handle = hit;
        cropState.startX = p.x;
        cropState.startY = p.y;
        cropState.startBox = { ...cropState.box };
      }

      function onCropMove(e) {
        if (!cropState.img || !cropState.mode) return;
        e.preventDefault();
        const p = getPointer(e);
        const dx = (p.x - cropState.startX) / cropState.scale;
        const dy = (p.y - cropState.startY) / cropState.scale;
        const b = cropState.box;
        const s = cropState.startBox;

        if (cropState.mode === 'move') {
          b.x = s.x + dx;
          b.y = s.y + dy;
        } else {
          const ratio = cropState.aspectRatio;
          if (!ratio) {
            const min = 20;
            if (cropState.handle.includes('n')) {
              b.y = s.y + dy;
              b.h = s.h - dy;
            }
            if (cropState.handle.includes('s')) {
              b.h = s.h + dy;
            }
            if (cropState.handle.includes('w')) {
              b.x = s.x + dx;
              b.w = s.w - dx;
            }
            if (cropState.handle.includes('e')) {
              b.w = s.w + dx;
            }

            if (b.w < min) {
              b.w = min;
              if (cropState.handle.includes('w')) b.x = s.x + (s.w - min);
            }
            if (b.h < min) {
              b.h = min;
              if (cropState.handle.includes('n')) b.y = s.y + (s.h - min);
            }
          } else {
            const horizontalDelta = cropState.handle.includes('e') ? dx : -dx;
            const verticalDelta = cropState.handle.includes('s') ? dy : -dy;
            const useHorizontal = Math.abs(horizontalDelta) >= Math.abs(verticalDelta * ratio);
            const nextW = useHorizontal ? s.w + horizontalDelta : s.w + verticalDelta * ratio;
            const targetW = Math.max(20, nextW);
            const targetH = targetW / ratio;

            b.w = targetW;
            b.h = targetH;
            b.x = cropState.handle.includes('w') ? s.x + (s.w - targetW) : s.x;
            b.y = cropState.handle.includes('n') ? s.y + (s.h - targetH) : s.y;
          }
        }

        clampBoxToImage();
        drawCropCanvas();
      }

      function onCropUp() {
        cropState.mode = null;
        cropState.handle = null;
      }

      cropCanvas.addEventListener('mousedown', onCropDown);
      window.addEventListener('mousemove', onCropMove);
      window.addEventListener('mouseup', onCropUp);

      cropCanvas.addEventListener('touchstart', onCropDown, { passive: false });
      window.addEventListener('touchmove', onCropMove, { passive: false });
      window.addEventListener('touchend', onCropUp, { passive: false });

      const cropAspectRatio = document.getElementById('cropAspectRatio');
      cropAspectRatio.addEventListener('change', () => {
        setCropAspectRatio(cropAspectRatio.value, true);
      });
      applyCropPreset(pageConfig.cropPreset);
      setCropAspectRatio(cropAspectRatio.value, false);

      cropImageInput.addEventListener('change', async () => {
        if (!cropImageInput.files || cropImageInput.files.length === 0) return;
        try {
          const img = await fileToImage(cropImageInput.files[0]);
          cropState.img = img;
          cropState.box = cropState.aspectRatio ? buildRatioBox(img, cropState.aspectRatio) : buildDefaultBox(img);
          clampBoxToImage();
          drawCropCanvas();
          setStatus(cropStatus, t('status.imageLoaded'), 'ok');
        } catch {
          setStatus(cropStatus, t('status.loadFailed'), 'error');
        }
      });

      document.getElementById('resetCropBtn').addEventListener('click', () => {
        if (!cropState.img) return;
        const img = cropState.img;
        cropState.box = cropState.aspectRatio ? buildRatioBox(img, cropState.aspectRatio) : buildDefaultBox(img);
        clampBoxToImage();
        drawCropCanvas();
        setStatus(cropStatus, t('status.cropReset'), 'ok');
      });

      const enableCropResize = document.getElementById('enableCropResize');
      const cropResizeWidthWrap = document.getElementById('cropResizeWidthWrap');
      const cropResizeHeightWrap = document.getElementById('cropResizeHeightWrap');
      enableCropResize.addEventListener('change', () => {
        const show = enableCropResize.checked;
        cropResizeWidthWrap.classList.toggle('hidden', !show);
        cropResizeHeightWrap.classList.toggle('hidden', !show);
      });
      if (pageConfig.enableCropResize) {
        enableCropResize.checked = true;
        cropResizeWidthWrap.classList.remove('hidden');
        cropResizeHeightWrap.classList.remove('hidden');
      }

      document.getElementById('confirmCropBtn').addEventListener('click', async () => {
        if (!cropState.img || !cropImageInput.files || cropImageInput.files.length === 0) {
          setStatus(cropStatus, t('status.uploadFirst'), 'error');
          return;
        }

        const format = document.getElementById('cropFormat').value;
        const mimeType = `image/${format}`;
        if (!canEncode(mimeType)) {
          setStatus(cropStatus, t('error.notSupported', { format: format.toUpperCase() }), 'error');
          return;
        }

        try {
          setStatus(cropStatus, t('status.cropProcessing'));
          const img = cropState.img;
          const b = cropState.box;
          let outW = Math.max(1, Math.round(b.w));
          let outH = Math.max(1, Math.round(b.h));

          if (enableCropResize.checked) {
            const rw = Number(document.getElementById('cropResizeWidth').value);
            const rh = Number(document.getElementById('cropResizeHeight').value);
            const hasW = Number.isFinite(rw) && rw > 0;
            const hasH = Number.isFinite(rh) && rh > 0;
            if (!hasW && !hasH) {
              throw new Error(t('error.resizeParams'));
            }
            const ratio = Math.min(hasW ? rw / outW : Infinity, hasH ? rh / outH : Infinity, 1);
            outW = Math.max(1, Math.round(outW * ratio));
            outH = Math.max(1, Math.round(outH * ratio));
          }

          const quality = toQuality(document.getElementById('cropQuality').value, 0.9);
          const blob = await renderToBlob(
            img,
            mimeType,
            quality,
            Math.round(b.x),
            Math.round(b.y),
            Math.round(b.w),
            Math.round(b.h),
            outW,
            outH
          );

          if (!blob) throw new Error('Crop failed.');
          const file = cropImageInput.files[0];
          const base = file.name.replace(/\.[^.]+$/, '') || 'image';
          const mode = await downloadBlob(blob, `${base}-crop.${extForFormat(format)}`);
          setStatus(
            cropStatus,
            mode === 'ios-preview' ? t('status.previewIos') : t('status.cropDone'),
            'ok'
          );
        } catch (err) {
          setStatus(cropStatus, err.message || t('error.cropFailed'), 'error');
        }
      });

      drawCropCanvas();

      // Compress tab
      document.getElementById('compressBtn').addEventListener('click', async () => {
        const fileInput = document.getElementById('compressImage');
        const statusEl = document.getElementById('compressStatus');
        if (!fileInput.files || fileInput.files.length === 0) {
          setStatus(statusEl, t('status.chooseImage'), 'error');
          return;
        }

        const file = fileInput.files[0];
        const format = document.getElementById('compressFormat').value;
        const mimeType = `image/${format}`;
        if (!canEncode(mimeType)) {
          setStatus(statusEl, t('error.notSupported', { format: format.toUpperCase() }), 'error');
          return;
        }

        setStatus(statusEl, t('status.compressing'));
        try {
          const img = await fileToImage(file);
          const quality = toQuality(document.getElementById('compressQuality').value, 0.7);
          const blob = await renderToBlob(img, mimeType, quality, 0, 0, img.width, img.height, img.width, img.height);
          if (!blob) throw new Error('Compress failed.');
          const base = file.name.replace(/\.[^.]+$/, '') || 'image';
          const mode = await downloadBlob(blob, `${base}-compressed.${extForFormat(format)}`);
          setStatus(
            statusEl,
            mode === 'ios-preview' ? t('status.previewIos') : t('status.compressDone'),
            'ok'
          );
        } catch (err) {
          setStatus(statusEl, err.message || t('error.compressFailed'), 'error');
        }
      });
    </script>
  </body>
</html>
